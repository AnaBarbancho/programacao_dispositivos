<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskManager 2FA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<header class="fixed-top bg-light shadow-sm">
    <nav class="container d-flex justify-content-between align-items-center py-2">
        <a class="navbar-brand" href="#">TaskManager</a>
        <div>
            <button id="btn-login" class="btn btn-outline-primary me-2">Login</button>
            <button id="btn-register" class="btn btn-primary">Registrar</button>
            <button id="btn-logout" class="btn btn-danger d-none">Logout</button>
        </div>
    </nav>
</header>

<main class="container mt-5 pt-5">

    <!-- Login / Registro -->
    <div id="auth-section" class="my-5">
        <div id="register-form" class="card p-4 mb-4 d-none">
            <h3>Registrar</h3>
            <form id="form-register">
                <div class="mb-3">
                    <label>Usu√°rio</label>
                    <input type="text" id="reg-username" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label>Senha</label>
                    <input type="password" id="reg-senha" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label>N√≠vel de Acesso</label>
                    <select id="reg-nivel" class="form-control" required>
                        <option value="visualizacao">Visualiza√ß√£o</option>
                        <option value="gerencial">Gerencial</option>
                        <option value="administrativo">Administrativo</option>
                    </select>
                </div>
                <button class="btn btn-primary">Registrar</button>
            </form>
            
            <small class="text-muted">Ap√≥s registrar, use o segredo 2FA no Google Authenticator</small>
            <div id="secret2FA" class="mt-2"></div>
        </div>

        <div id="login-form" class="card p-4 d-none">
            <h3>Login</h3>
            <form id="form-login">
                <div class="mb-3">
                    <label>Usu√°rio</label>
                    <input type="text" id="login-username" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label>Senha</label>
                    <input type="password" id="login-senha" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label>Token 2FA</label>
                    <input type="text" id="login-2fa" class="form-control" required>
                </div>
                <button class="btn btn-primary">Login</button>
            </form>
        </div>
    </div>

    <!-- Se√ß√£o de tarefas (apenas logado) -->
    <div id="app-section" class="d-none">
        <h2>Suas Tarefas</h2>
        <form id="task-form" class="mb-3">
            <input type="text" id="titulo" placeholder="T√≠tulo" class="form-control mb-2" required>
            <textarea id="descricao" placeholder="Descri√ß√£o" class="form-control mb-2"></textarea>
            <div class="form-check mb-2">
                <input type="checkbox" id="concluida" class="form-check-input">
                <label for="concluida" class="form-check-label">Conclu√≠da</label>
            </div>
            <button class="btn btn-primary">Adicionar Tarefa</button>
        </form>
        <ul id="task-list" class="list-group"></ul>
    </div>

</main>

<script>
const API_URL = "http://localhost:3000";

let tokenJWT = null;
let nivelAcesso = null;

// ======== Fun√ß√µes JWT e controle de acesso ========

function parseJwt(token) {
    try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
    } catch (e) {
        return null;
    }
}

function controlarPermissoes(nivel) {
    nivelAcesso = nivel;

    const form = document.getElementById("task-form");

    if (nivel === "visualizacao") {
        form.classList.add("d-none");
    } else {
        form.classList.remove("d-none");
    }
}

// ======== Bot√µes de interface ========

document.getElementById("btn-login").onclick = () => {
    document.getElementById("login-form").classList.remove("d-none");
    document.getElementById("register-form").classList.add("d-none");
};

document.getElementById("btn-register").onclick = () => {
    document.getElementById("register-form").classList.remove("d-none");
    document.getElementById("login-form").classList.add("d-none");
};

document.getElementById("btn-logout").onclick = () => {
    tokenJWT = null;
    nivelAcesso = null;
    document.getElementById("app-section").classList.add("d-none");
    document.getElementById("auth-section").classList.remove("d-none");
    document.getElementById("btn-logout").classList.add("d-none");
};

// ======== Registro ========

document.getElementById("form-register").onsubmit = async (e) => {
    e.preventDefault();
    const username = document.getElementById("reg-username").value;
    const senha = document.getElementById("reg-senha").value;
    const nivelAcesso = document.getElementById("reg-nivel").value; // üëà pegar valor do select

    const res = await fetch(`${API_URL}/registro`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, senha, nivelAcesso }) // üëà enviar pro backend
    });
    const data = await res.json();
    if(res.ok){
        document.getElementById("secret2FA").innerText = `Seu segredo 2FA: ${data.secret2FA}`;
        alert("Usu√°rio criado! Use esse segredo no Google Authenticator");
    } else {
        alert(data.msg);
    }
};

// ======== Login ========

document.getElementById("form-login").onsubmit = async (e) => {
    e.preventDefault();
    const username = document.getElementById("reg-username").value;
    const senha = document.getElementById("reg-senha").value;
    const nivelAcesso = document.getElementById("reg-nivel").value;
    const token2FA = document.getElementById("login-2fa").value;

    const res = await fetch(`${API_URL}/login`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, senha, token2FA })
    });
    const data = await res.json();
    if(res.ok){
        tokenJWT = data.token;

        const payload = parseJwt(tokenJWT);
        controlarPermissoes(payload.nivelAcesso);

        document.getElementById("auth-section").classList.add("d-none");
        document.getElementById("app-section").classList.remove("d-none");
        document.getElementById("btn-logout").classList.remove("d-none");

        loadTasks();
    } else {
        alert(data.msg);
    }
};

// ======== Tarefas (CRUD) ========

async function loadTasks() {
    const res = await fetch(`${API_URL}/tarefas`, {
        headers: { "Authorization": `Bearer ${tokenJWT}` }
    });
    const tarefas = await res.json();
    const list = document.getElementById("task-list");
    list.innerHTML = "";

    tarefas.forEach(t => {
        const li = document.createElement("li");
        li.className = "list-group-item d-flex justify-content-between align-items-center";
        li.innerHTML = `
            <div>
                <strong>${t.titulo}</strong> - ${t.descricao || ""}
                ${t.concluida ? "‚úÖ" : ""}
            </div>
            <div>
                ${nivelAcesso !== "visualizacao" ? `
                    <button class="btn btn-sm btn-success" onclick="toggleComplete(${t.id}, ${t.concluida})">‚úîÔ∏è</button>
                ` : ""}
                ${nivelAcesso === "administrativo" ? `
                    <button class="btn btn-sm btn-danger" onclick="deleteTask(${t.id})">üóëÔ∏è</button>
                ` : ""}
            </div>
        `;
        list.appendChild(li);
    });
}

document.getElementById("task-form").onsubmit = async (e) => {
    e.preventDefault();
    const titulo = document.getElementById("titulo").value;
    const descricao = document.getElementById("descricao").value;
    const concluida = document.getElementById("concluida").checked;

    const res = await fetch(`${API_URL}/tarefas`, {
        method: "POST",
        headers: { 
            "Content-Type": "application/json",
            "Authorization": `Bearer ${tokenJWT}`
        },
        body: JSON.stringify({ titulo, descricao, concluida })
    });
    if(res.ok){
        document.getElementById("titulo").value = "";
        document.getElementById("descricao").value = "";
        document.getElementById("concluida").checked = false;
        loadTasks();
    }
};

async function toggleComplete(id, atual) {
    await fetch(`${API_URL}/tarefas/${id}`, {
        method: "PUT",
        headers: { 
            "Content-Type": "application/json",
            "Authorization": `Bearer ${tokenJWT}`
        },
        body: JSON.stringify({ concluida: !atual })
    });
    loadTasks();
}

async function deleteTask(id) {
    await fetch(`${API_URL}/tarefas/${id}`, {
        method: "DELETE",
        headers: { "Authorization": `Bearer ${tokenJWT}` }
    });
    loadTasks();
}
</script>

</body>
</html>
