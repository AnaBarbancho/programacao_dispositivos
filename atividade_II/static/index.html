<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskManager 2FA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --success-color: #4cc9f0;
            --light-color: #f8f9fa;
            --dark-color: #212529;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fb;
            color: var(--dark-color);
        }
        
        /* Landing Page Styles */
        .hero-section {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 100px 0;
            text-align: center;
            margin-top: 56px;
        }
        
        .feature-card {
            transition: transform 0.3s;
            border: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            height: 100%;
        }
        
        .feature-card:hover {
            transform: translateY(-10px);
        }
        
        .feature-icon {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        
        .section-title {
            position: relative;
            margin-bottom: 2rem;
        }
        
        .section-title:after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 4px;
            background-color: var(--primary-color);
            border-radius: 2px;
        }
        
        /* Kanban Styles */
        .kanban-container {
            display: flex;
            gap: 20px;
            overflow-x: auto;
            padding: 20px 0;
            margin-top: 20px;
        }
        
        .kanban-column {
            flex: 1;
            min-width: 300px;
            background-color: #f0f2f5;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .kanban-column h5 {
            text-align: center;
            padding-bottom: 10px;
            margin-bottom: 15px;
            border-bottom: 2px solid #ddd;
        }
        
        .kanban-card {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s;
            cursor: pointer;
        }
        
        .kanban-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .kanban-card h6 {
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .kanban-card p {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
        }
        
        .kanban-card .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
        
        .kanban-card .badge {
            font-size: 0.7rem;
        }
        
        /* Navigation */
        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
            color: var(--primary-color) !important;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        /* Auth Forms */
        .auth-card {
            border: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-radius: 10px;
        }
        
        .auth-card .card-header {
            background-color: var(--primary-color);
            color: white;
            border-radius: 10px 10px 0 0 !important;
            text-align: center;
            font-weight: bold;
        }
        
        /* Footer */
        footer {
            background-color: var(--dark-color);
            color: white;
            padding: 40px 0;
            margin-top: 60px;
        }
        
        /* Estilo para o formulário de edição */
        .edit-form {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            border: 1px solid #dee2e6;
        }
        
        .edit-form .form-control {
            margin-bottom: 10px;
        }
        
        .edit-form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 10px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .kanban-container {
                flex-direction: column;
            }
            
            .kanban-column {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>

<header class="fixed-top bg-light shadow-sm">
    <nav class="container d-flex justify-content-between align-items-center py-2">
        <a class="navbar-brand" href="#"><i class="fas fa-tasks me-2"></i>TaskManager</a>
        <div>
            <button id="btn-login" class="btn btn-outline-primary me-2">Login</button>
            <!-- Registro público removido: apenas admins podem criar usuários via painel -->
            <button id="btn-register" class="btn btn-primary d-none">Registrar</button>
            <button id="btn-logout" class="btn btn-danger d-none">Logout</button>
        </div>
    </nav>
</header>

<!-- Landing Page Content -->
<section id="landing-section">
    <div class="hero-section">
        <div class="container">
            <h1 class="display-4 fw-bold">Gerencie suas tarefas com segurança</h1>
            <p class="lead">TaskManager oferece autenticação de dois fatores para proteger suas informações</p>
            <button id="btn-get-started" class="btn btn-light btn-lg mt-3">Começar Agora</button>
        </div>
    </div>
    
    <div class="container my-5 py-5">
        <h2 class="text-center section-title">Por que escolher o TaskManager?</h2>
        <div class="row g-4 mt-4">
            <div class="col-md-4">
                <div class="card feature-card">
                    <div class="card-body text-center p-4">
                        <div class="feature-icon">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <h5>Segurança Máxima</h5>
                        <p>Autenticação de dois fatores para proteger suas tarefas e informações pessoais.</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card feature-card">
                    <div class="card-body text-center p-4">
                        <div class="feature-icon">
                            <i class="fas fa-columns"></i>
                        </div>
                        <h5>Visualização Kanban</h5>
                        <p>Organize suas tarefas em colunas visuais para melhor acompanhamento do progresso.</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card feature-card">
                    <div class="card-body text-center p-4">
                        <div class="feature-icon">
                            <i class="fas fa-user-lock"></i>
                        </div>
                        <h5>Controle de Acesso</h5>
                        <p>Diferentes níveis de permissão para equipes: visualização, gerencial e administrativo.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<main class="container mt-5 pt-5">

    <!-- Login / Registro -->
    <div id="auth-section" class="my-5 d-none">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div id="register-form" class="card auth-card d-none">
                    <div class="card-header py-3">
                        <h4 class="mb-0">Criar Nova Conta</h4>
                    </div>
                    <div class="card-body p-4">
                        <form id="form-register">
                            <div class="mb-3">
                                <label class="form-label">Usuário</label>
                                <input type="text" id="reg-username" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Senha</label>
                                <input type="password" id="reg-senha" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <!-- Nível de acesso removido do registro público: apenas admins podem criar outros níveis -->
                                <input type="hidden" id="reg-nivel" value="visualizacao">
                            </div>
                            <button class="btn btn-primary w-100 py-2">Registrar</button>
                        </form>
                        
                        <div class="mt-3 p-3 bg-light rounded">
                            <small class="text-muted">Após registrar, use o segredo 2FA no Google Authenticator</small>
                            <div id="secret2FA" class="mt-2 fw-bold"></div>
                        </div>
                    </div>
                </div>

                <div id="login-form" class="card auth-card d-none">
                    <div class="card-header py-3">
                        <h4 class="mb-0">Acessar Sua Conta</h4>
                    </div>
                    <div class="card-body p-4">
                        <form id="form-login">
                            <div class="mb-3">
                                <label class="form-label">Usuário</label>
                                <input type="text" id="login-username" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Senha</label>
                                <input type="password" id="login-senha" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Token 2FA</label>
                                <input type="text" id="login-2fa" class="form-control" required>
                            </div>
                            <button class="btn btn-primary w-100 py-2">Login</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Seção de tarefas (apenas logado) -->
    <div id="app-section" class="d-none">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-tasks me-2"></i><span id="tasks-title">Suas Tarefas</span></h2>
            <div>
                <span class="badge bg-primary me-2">Nível: <span id="user-level"></span></span>
                <button id="btn-add-task" class="btn btn-primary">
                    <i class="fas fa-plus me-1"></i> Nova Tarefa
                </button>
            </div>
        </div>
        <!-- Painel para administradores criarem usuários -->
        <div id="admin-create-user" class="card p-4 mb-4 d-none">
            <h5>Criar Novo Usuário (Admin)</h5>
            <form id="form-admin-create">
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Usuário</label>
                            <input type="text" id="admin-username" class="form-control" required>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Senha</label>
                            <input type="password" id="admin-senha" class="form-control" required>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Nível de Acesso</label>
                            <select id="admin-nivel" class="form-control">
                                <option value="visualizacao">Visualização</option>
                                <option value="gerencial">Gerencial</option>
                                <option value="administrativo">Administrativo</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="d-flex justify-content-end">
                    <button type="submit" class="btn btn-success">Criar Usuário</button>
                </div>
                <div class="mt-3 p-2 bg-light rounded d-none" id="admin-create-result"></div>
            </form>
        </div>
        
        <div id="task-form-container" class="card p-4 mb-4">
            <h5>Adicionar Nova Tarefa</h5>
            <form id="task-form">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Título</label>
                            <input type="text" id="titulo" class="form-control" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <select id="status" class="form-control">
                                <option value="pendente">Pendente</option>
                                <option value="andamento">Em Andamento</option>
                                <option value="concluida">Concluída</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Descrição</label>
                    <textarea id="descricao" class="form-control" rows="3"></textarea>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <div class="form-check">
                        <input type="checkbox" id="concluida" class="form-check-input">
                        <label for="concluida" class="form-check-label">Marcar como concluída</label>
                    </div>
                    <div>
                        <button type="button" id="btn-cancel-task" class="btn btn-outline-secondary me-2">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Adicionar Tarefa</button>
                    </div>
                </div>
            </form>
        </div>
        
        <!-- Kanban Board -->
        <div class="kanban-container">
            <div class="kanban-column">
                <h5><i class="fas fa-clock me-2"></i>Pendentes</h5>
                <div id="column-pendente" class="kanban-column-content">
                    <!-- Tarefas pendentes serão inseridas aqui -->
                </div>
            </div>
            
            <div class="kanban-column">
                <h5><i class="fas fa-spinner me-2"></i>Em Andamento</h5>
                <div id="column-andamento" class="kanban-column-content">
                    <!-- Tarefas em andamento serão inseridas aqui -->
                </div>
            </div>
            
            <div class="kanban-column">
                <h5><i class="fas fa-check-circle me-2"></i>Concluídas</h5>
                <div id="column-concluida" class="kanban-column-content">
                    <!-- Tarefas concluídas serão inseridas aqui -->
                </div>
            </div>
        </div>
    </div>

</main>

<footer class="bg-dark text-white">
    <div class="container">
        <div class="row">
            <div class="col-md-4">
                <h5><i class="fas fa-tasks me-2"></i>TaskManager</h5>
                <p>Gerencie suas tarefas com segurança e eficiência.</p>
            </div>
            <div class="col-md-4">
                <h5>Links Rápidos</h5>
                <ul class="list-unstyled">
                    <li><a href="#" class="text-white">Início</a></li>
                    <li><a href="#" class="text-white">Sobre</a></li>
                    <li><a href="#" class="text-white">Contato</a></li>
                </ul>
            </div>
            <div class="col-md-4">
                <h5>Contato</h5>
                <p><i class="fas fa-envelope me-2"></i>contato@taskmanager.com</p>
                <p><i class="fas fa-phone me-2"></i>(11) 99999-9999</p>
            </div>
        </div>
        <hr>
        <div class="text-center">
            <p>&copy; 2023 TaskManager. Todos os direitos reservados.</p>
        </div>
    </div>
</footer>

<script>
const API_URL = "http://localhost:3000";

let tokenJWT = null;
// Monkey-patch fetch to normalize accidental URLs like '/usuarios:1' -> '/usuarios/1'
// This helps when some code (or third-party) accidentally concatenates ':' before an id.
(function(){
    const _fetch = window.fetch.bind(window);
    window.fetch = async (input, init) => {
        try {
            let url = input;
            if (typeof input === 'object' && input.url) {
                url = input.url;
            }

            if (typeof url === 'string') {
                // Normalize patterns like '/usuarios:123' -> '/usuarios/123'
                const fixed = url.replace(/(\/usuarios):([0-9]+)\b/g, '$1/$2');
                if (fixed !== url) {
                    console.warn(`Normalized URL from ${url} to ${fixed}`);
                    if (typeof input === 'string') input = fixed;
                    else if (typeof input === 'object') input = new Request(fixed, input);
                }
            }

            return await _fetch(input, init);
        } catch (err) {
            return Promise.reject(err);
        }
    };
})();
let nivelAcesso = null;
let editingTaskId = null;

// ======== Funções JWT e controle de acesso ========

function parseJwt(token) {
    try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
    } catch (e) {
        return null;
    }
}

function controlarPermissoes(nivel) {
    nivelAcesso = nivel;
    document.getElementById('user-level').textContent = nivel;

    const formContainer = document.getElementById("task-form-container");
    const tasksTitle = document.getElementById('tasks-title');

    if (nivel === "visualizacao") {
        formContainer.classList.add("d-none");
        document.getElementById('btn-add-task').classList.add('d-none');
        tasksTitle.textContent = "Todas as Tarefas";
        // esconder painel de criação de usuários para não-admins
        const adminPanel = document.getElementById('admin-create-user');
        if (adminPanel) adminPanel.classList.add('d-none');
    } else {
        formContainer.classList.remove("d-none");
        document.getElementById('btn-add-task').classList.remove('d-none');
        tasksTitle.textContent = "Suas Tarefas";
        // mostrar painel de admin se for administrativo
        const adminPanel = document.getElementById('admin-create-user');
        if (adminPanel) {
            if (nivel === 'administrativo') {
                adminPanel.classList.remove('d-none');
            } else {
                adminPanel.classList.add('d-none');
            }
        }
    }
}

// ======== Botões de interface ========

document.getElementById("btn-get-started").onclick = () => {
    // Abrir a tela de autenticação com foco no login. Registro público foi removido.
    document.getElementById("landing-section").classList.add("d-none");
    document.getElementById("auth-section").classList.remove("d-none");
    document.getElementById("login-form").classList.remove("d-none");
    document.getElementById("register-form").classList.add("d-none");
};

document.getElementById("btn-login").onclick = () => {
    document.getElementById("landing-section").classList.add("d-none");
    document.getElementById("auth-section").classList.remove("d-none");
    document.getElementById("login-form").classList.remove("d-none");
    document.getElementById("register-form").classList.add("d-none");
};

document.getElementById("btn-register").onclick = () => {
    // Botão de registro oculto para usuários comuns. Caso seja necessário, admins devem usar o painel.
    document.getElementById("landing-section").classList.add("d-none");
    document.getElementById("auth-section").classList.remove("d-none");
    document.getElementById("login-form").classList.remove("d-none");
    document.getElementById("register-form").classList.add("d-none");
};

document.getElementById("btn-logout").onclick = () => {
    tokenJWT = null;
    nivelAcesso = null;
    document.getElementById("app-section").classList.add("d-none");
    document.getElementById("auth-section").classList.add("d-none");
    document.getElementById("landing-section").classList.remove("d-none");
    document.getElementById("btn-logout").classList.add("d-none");
};

document.getElementById("btn-add-task").onclick = () => {
    document.getElementById("task-form-container").classList.toggle("d-none");
};

document.getElementById("btn-cancel-task").onclick = () => {
    document.getElementById("task-form-container").classList.add("d-none");
    document.getElementById("titulo").value = "";
    document.getElementById("descricao").value = "";
    document.getElementById("concluida").checked = false;
    document.getElementById("status").value = "pendente";
};

// ======== Registro ========

document.getElementById("form-register").onsubmit = async (e) => {
    e.preventDefault();
    // Registro público desativado — apenas administradores podem criar contas.
    alert('Registro público desativado. Somente administradores podem criar novos usuários.');
};

// ======== Login ========

document.getElementById("form-login").onsubmit = async (e) => {
    e.preventDefault();
    const username = document.getElementById("login-username").value;
    const senha = document.getElementById("login-senha").value;
    const token2FA = document.getElementById("login-2fa").value;

    const res = await fetch(`${API_URL}/login`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, senha, token2FA })
    });
    const data = await res.json();
    if(res.ok){
        tokenJWT = data.token;

        const payload = parseJwt(tokenJWT);
        controlarPermissoes(payload.nivelAcesso);

        document.getElementById("auth-section").classList.add("d-none");
        document.getElementById("app-section").classList.remove("d-none");
        document.getElementById("btn-logout").classList.remove("d-none");

    // Mostrar botão login novamente após logout
    const loginBtn = document.getElementById("btn-login");
    if (loginBtn) loginBtn.classList.remove("d-none");
        loadTasks();
    } else {
        alert(data.msg);
    }
};

// ======== Tarefas (CRUD) ========

async function loadTasks() {
    try {
        const res = await fetch(`${API_URL}/tarefas`, {
            headers: { "Authorization": `Bearer ${tokenJWT}` }
        });
        
        if (!res.ok) {
            // Tentar ler JSON com segurança; se não for JSON, ler texto para diagnóstico
            let errorData;
            try {
                errorData = await res.json();
            } catch (e) {
                const text = await res.text();
                console.error(`Erro ao carregar tarefas: status=${res.status} url=${res.url} body=${text}`);
        // Esconder o botão de login e mostrar logout quando autenticado
        const loginBtn = document.getElementById("btn-login");
        if (loginBtn) loginBtn.classList.add("d-none");
        document.getElementById("btn-logout").classList.remove("d-none");
                return;
            }
            console.error("Erro ao carregar tarefas:", errorData);
            alert(`Erro ao carregar tarefas: ${errorData.msg || res.statusText}`);
            return;
        }
        
    const tarefas = await res.json();
        console.log("Tarefas carregadas:", tarefas);
        console.log("Número de tarefas:", tarefas.length);
        console.log("Nível de acesso:", nivelAcesso);
        
        // Limpar colunas do Kanban
        document.getElementById('column-pendente').innerHTML = '';
        document.getElementById('column-andamento').innerHTML = '';
        document.getElementById('column-concluida').innerHTML = '';
        
        if (!Array.isArray(tarefas)) {
            console.error("Resposta não é um array:", tarefas);
            return;
        }
        
        tarefas.forEach(t => {
        const card = document.createElement('div');
        card.className = 'kanban-card';
        // Drag apenas para quem pode editar
        if (nivelAcesso !== "visualizacao") {
            card.setAttribute('draggable', 'true');
        } else {
            card.setAttribute('draggable', 'false');
        }
        card.setAttribute('data-id', t.id);
        
        // Determinar a cor da badge baseada no status
        let badgeClass = 'bg-secondary';
        if (t.status === 'pendente') badgeClass = 'bg-warning';
        if (t.status === 'andamento') badgeClass = 'bg-primary';
        if (t.status === 'concluida') badgeClass = 'bg-success';
        
        // Escapar strings para evitar problemas com aspas no HTML
        const tituloEscapado = (t.titulo || "").replace(/'/g, "&#39;").replace(/"/g, "&quot;");
        const descricaoEscapada = (t.descricao || "").replace(/'/g, "&#39;").replace(/"/g, "&quot;");
        const statusEscapado = (t.status || "").replace(/'/g, "&#39;");
        
        card.innerHTML = `
            <h6>${t.titulo || ""}</h6>
            <p>${t.descricao || ""}</p>
            ${nivelAcesso === "visualizacao" && t.usuario ? `
                <small class="text-muted"><i class="fas fa-user me-1"></i>Por: ${t.usuario.username || "N/A"}</small>
            ` : ""}
            <div class="card-footer">
                <span class="badge ${badgeClass}">${t.status || ""}</span>
                <div>
                    ${nivelAcesso !== "visualizacao" ? `
                        <button class="btn btn-sm btn-outline-primary" onclick="editTask(${t.id}, '${tituloEscapado}', '${descricaoEscapada}', '${statusEscapado}')">
                            <i class="fas fa-edit"></i>
                        </button>
                    ` : ""}
                    ${nivelAcesso === "administrativo" ? `
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteTask(${t.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    ` : ""}
                </div>
            </div>
        `;
        
        // Adicionar evento de drag para o card (apenas se tiver permissão de editar)
        if (nivelAcesso !== "visualizacao") {
            card.addEventListener('dragstart', handleDragStart);
        }
        
        // Adicionar à coluna correta
        document.getElementById(`column-${t.status}`).appendChild(card);
    });
    
    // Tornar as colunas alvos de drop (apenas se tiver permissão de editar)
    if (nivelAcesso !== "visualizacao") {
        const columns = document.querySelectorAll('.kanban-column-content');
        columns.forEach(column => {
            column.addEventListener('dragover', handleDragOver);
            column.addEventListener('drop', handleDrop);
        });
    }
    } catch (error) {
        console.error("Erro ao carregar tarefas:", error);
        alert("Erro ao carregar tarefas. Verifique o console para mais detalhes.");
    }
}

// Funções de drag and drop
function handleDragStart(e) {
    e.dataTransfer.setData('text/plain', e.target.getAttribute('data-id'));
    e.target.classList.add('dragging');
}

function handleDragOver(e) {
    e.preventDefault();
}

function handleDrop(e) {
    e.preventDefault();
    const taskId = e.dataTransfer.getData('text/plain');
    const columnId = e.target.closest('.kanban-column-content').id;
    const newStatus = columnId.replace('column-', '');
    
    updateTaskStatus(taskId, newStatus);
}

async function updateTaskStatus(taskId, newStatus) {
    await fetch(`${API_URL}/tarefas/${taskId}`, {
        method: "PUT",
        headers: { 
            "Content-Type": "application/json",
            "Authorization": `Bearer ${tokenJWT}`
        },
        body: JSON.stringify({ status: newStatus })
    });
    loadTasks();
}

document.getElementById("task-form").onsubmit = async (e) => {
    e.preventDefault();
    const titulo = document.getElementById("titulo").value;
    const descricao = document.getElementById("descricao").value;
    const status = document.getElementById("status").value;

    const res = await fetch(`${API_URL}/tarefas`, {
        method: "POST",
        headers: { 
            "Content-Type": "application/json",
            "Authorization": `Bearer ${tokenJWT}`
        },
        body: JSON.stringify({ titulo, descricao, status })
    });
    if(res.ok){
        document.getElementById("titulo").value = "";
        document.getElementById("descricao").value = "";
        document.getElementById("status").value = "pendente";
        document.getElementById("task-form-container").classList.add("d-none");
        loadTasks();
    }
};

// ======== Criação de usuários (pelo admin) ========
document.getElementById('form-admin-create').onsubmit = async (e) => {
    e.preventDefault();

    if (!tokenJWT) {
        alert('Necessário estar autenticado como administrador.');
        return;
    }

    const username = document.getElementById('admin-username').value;
    const senha = document.getElementById('admin-senha').value;
    const nivel = document.getElementById('admin-nivel').value;

    try {
        const res = await fetch(`${API_URL}/usuarios`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${tokenJWT}`
            },
            body: JSON.stringify({ username, senha, nivelAcesso: nivel })
        });

        const resultEl = document.getElementById('admin-create-result');

        // ler resposta com segurança (pode ser HTML de erro)
        let data;
        try {
            data = await res.json();
        } catch (e) {
            const text = await res.text();
            console.error(`Resposta não-JSON ao criar usuário: status=${res.status} url=${res.url} body=${text}`);
            resultEl.classList.remove('d-none');
            resultEl.classList.remove('text-success');
            resultEl.classList.add('text-danger');
            resultEl.innerText = `Erro ao criar usuário: status ${res.status} - veja o console`;
            return;
        }

        if (res.ok) {
            resultEl.classList.remove('d-none');
            resultEl.classList.remove('text-danger');
            resultEl.classList.add('text-success');
            resultEl.innerText = `Usuário criado com sucesso. Segredo 2FA: ${data.secret2FA}`;
            // limpar formulário
            document.getElementById('admin-username').value = '';
            document.getElementById('admin-senha').value = '';
            document.getElementById('admin-nivel').value = 'visualizacao';
        } else {
            resultEl.classList.remove('d-none');
            resultEl.classList.remove('text-success');
            resultEl.classList.add('text-danger');
            resultEl.innerText = data.msg || `Erro ao criar usuário (status ${res.status})`;
        }
    } catch (err) {
        alert('Erro de rede ao criar usuário. Veja o console.');
        console.error(err);
    }
};

function editTask(id, currentTitulo, currentDescricao, currentStatus) {
    // Se já está editando esta tarefa, cancelar a edição
    if (editingTaskId === id) {
        cancelEditTask(id);
        return;
    }
    
    // Se está editando outra tarefa, cancelar primeiro
    if (editingTaskId) {
        cancelEditTask(editingTaskId);
    }
    
    // Encontrar o card da tarefa
    const taskCard = document.querySelector(`.kanban-card[data-id="${id}"]`);
    
    // Criar formulário de edição
    const editForm = document.createElement('div');
    editForm.className = 'edit-form';
    editForm.id = `edit-form-${id}`;
    editForm.innerHTML = `
        <div class="mb-2">
            <label class="form-label small">Título</label>
            <input type="text" class="form-control form-control-sm" id="edit-titulo-${id}" value="${currentTitulo}" required>
        </div>
        <div class="mb-2">
            <label class="form-label small">Descrição</label>
            <textarea class="form-control form-control-sm" id="edit-descricao-${id}" rows="2">${currentDescricao || ''}</textarea>
        </div>
        <div class="mb-2">
            <label class="form-label small">Status</label>
            <select class="form-control form-control-sm" id="edit-status-${id}">
                <option value="pendente" ${currentStatus === 'pendente' ? 'selected' : ''}>Pendente</option>
                <option value="andamento" ${currentStatus === 'andamento' ? 'selected' : ''}>Em Andamento</option>
                <option value="concluida" ${currentStatus === 'concluida' ? 'selected' : ''}>Concluída</option>
            </select>
        </div>
        <div class="edit-form-actions">
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="cancelEditTask(${id})">Cancelar</button>
            <button type="button" class="btn btn-sm btn-primary" onclick="saveTask(${id})">Salvar</button>
        </div>
    `;
    
    // Adicionar formulário ao card
    taskCard.appendChild(editForm);
    
    // Atualizar o ID da tarefa sendo editada
    editingTaskId = id;
}

function cancelEditTask(id) {
    const editForm = document.getElementById(`edit-form-${id}`);
    if (editForm) {
        editForm.remove();
    }
    
    // Se estamos cancelando a tarefa atualmente em edição, limpar o ID
    if (editingTaskId === id) {
        editingTaskId = null;
    }
}

async function saveTask(id) {
    const titulo = document.getElementById(`edit-titulo-${id}`).value;
    const descricao = document.getElementById(`edit-descricao-${id}`).value;
    const status = document.getElementById(`edit-status-${id}`).value;

    if (titulo && status) {
        await fetch(`${API_URL}/tarefas/${id}`, {
            method: "PUT",
            headers: { 
                "Content-Type": "application/json",
                "Authorization": `Bearer ${tokenJWT}`
            },
            body: JSON.stringify({ titulo, descricao, status })
        });
        
        // Limpar o ID da tarefa sendo editada
        editingTaskId = null;
        
        // Recarregar as tarefas
        loadTasks();
    }
}

async function deleteTask(id) {
    if (confirm("Tem certeza que deseja excluir esta tarefa?")) {
        await fetch(`${API_URL}/tarefas/${id}`, {
            method: "DELETE",
            headers: { "Authorization": `Bearer ${tokenJWT}` }
        });
        loadTasks();
    }
}
</script>

</body>
</html>